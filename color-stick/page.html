<!DOCTYPE html>
<html>
<head>
	<title></title>
</head>
<body>
    <div id="instructiontxt"> Chose field of view image to upload</div>
    <br>
<div id="canvas">Click to draw<br/></div>
<button onclick="clearPanel()">Clear</button>
<button onclick="nextPanel()">Next</button>
 <input type="file" onchange="previewFile()"><br>
 <img src="" height="0" alt="">
</body>
</html>



<script type="text/javascript">
function clearPanel() {
    ctx.addBack(my_image);
}

function nextPanel() {
    ctx.addNext(my_image);
}

var color_marks = [];
var curr_height = 1;

function c(img) {
    // Creates a new canvas element and appends it as a child
    // to the parent element, and returns the reference to
    // the newly created canvas element

    function createCanvas(parent, width, height) {
        var canvas = {};
        canvas.node = document.createElement("canvas");
        canvas.context = canvas.node.getContext("2d");
        canvas.node.width = width || 100;
        canvas.node.height = height || 100;

        parent.appendChild(canvas.node);

        return canvas;
        // canvas.node.width = width || 100;
        // canvas.node.height = height || 100;
        // parent.appendChild(canvas.node);
        // return canvas;
    }

    function storeCoordinate(xVal, yVal, array) {
        array.push({x: xVal, y: yVal});
    }

    function storeHeight(yVal, array){
        array.push(yVal);
    }

    function getAverage(array){
        var sum = 0;
        for( var i = 0; i < array.length; i++ ){
            sum += parseInt( array[i], 10 ); //don't forget to add the base
        }

        var avg = sum/array.length;
        return avg;
    }

    function init(container, width, height, fillColor) {
        var canvas = createCanvas(container, width, height);
        var coords = [];
        ctx = canvas.context;

        // define a custom fillCircle method
        ctx.fillCircle = function(x, y, radius, fillColor) {
            this.fillStyle = fillColor;
            this.beginPath();
            this.moveTo(x, y);
            this.arc(x, y, radius, 0, Math.PI * 2, false);
            this.fill();
        };

        // ctx.clearTo = function(fillColor) {
        //     ctx.fillStyle = fillColor;
        //     ctx.fillRect(0, 0, width, height);
        // };
        // ctx.clearTo(fillColor || "#ddd");

        ctx.addBack = function (img){
        	var image = new Image()
        	image.onload = function () {
        		console.log('here back');
        		ctx.drawImage(image, 0, 0, 800, 400);
        	}
        	image.src = img
        }
        ctx.addBack(img);

        ctx.addNext = function (img){
            var image = new Image()
            image.onload = function () {
                console.log('here next');
                console.log(coords);
                avg = getAverage(coords);
                color_marks.push(avg);
                coords = [];
                instructiontxt.innerHTML = "If " + curr_height + " foot mark is visible use click to draw small horizontal line on mark, when done click next. If not visible, click next.";
                curr_height += 1;
                console.log(color_marks);
                ctx.drawImage(image, 0, 0, 800, 400);
            }
            image.src = img
        }
        ctx.addNext(img);


        // bind mouse events
        canvas.node.onmousemove = function(e) {
            if (!canvas.isDrawing) {
               return;
            }
            var x = e.pageX - this.offsetLeft;
            var y = e.pageY - this.offsetTop;
            var radius = 5; // or whatever
            var fillColor = '#ff0000';
            // var coords = [];
            storeHeight(y, coords);
            console.log(y);
            ctx.fillCircle(x, y, radius, fillColor);
        };
        canvas.node.onmousedown = function(e) {
            canvas.isDrawing = true;
            console.log(canvas);
        };
        canvas.node.onmouseup = function(e) {
            canvas.isDrawing = false;
        };
    }

    var container = document.getElementById('canvas');
    init(container, 800, 400, '#ddd', img);

};

function previewFile() {
    // Where you will display your image
    var preview = document.querySelector('img');
    // The button where the user chooses the local image to display
    var file = document.querySelector('input[type=file]').files[0];
    // FileReader instance
    var reader  = new FileReader();

    // When the image is loaded we will set it as source of
    // our img tag
    reader.onloadend = function () {
      preview.src = reader.result;
      my_image = preview.src;
      console.log(reader);
	  c(preview.src);
    }
    
    if (file) {
      // Load image as a base64 encoded URI
      reader.readAsDataURL(file);

    } else {
      preview.src = "";
    }
}


</script>